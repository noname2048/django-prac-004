
version: 2.1

jobs:
  simple_build: # job names
    docker: # docker image
    - image: noname2048/askbanana:simple
      auth:
        username: noname2048 
        password: $DOCKERHUB_PASSWORD

    - image: postgres
      ports:
        - 5431:5432
      volumes:
        - ./docker_volumes/postgres_container_volume:/var/lib/postgresql/data
      environment: 
        - POSTGRES_DB=postgres
        - POSTGRES_USER=postgres
        - POSTGRES_PASSWORD=postgres
        - POSTGRES_INITDB_ARGS=--encoding=UTF-8

    - image: redis
      ports:
        - 6378:6379
      volumes:
        - ./docker_volumes/redis_container_volume:/data
      command:
        - /bin/bash
        - -c
        - |
          redis-server --appendonly yes --requirepass "redis"

    working_directory: /askbanana/django_project # ~/project # default
    steps:
    - run:
        name: send to codecov
        command: |
          coverage run ./manage.py test
          codecov -t $CODECOV_TOKEN

workflows:
  version: 2
  test_django_docker: # workflow namespace
    jobs:
    - simple_build:
        filters:
          branches:
            only:
            - main
